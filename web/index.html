<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Raspberry Pi WebRTC Camera</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin: 0; padding: 0; background: #101214; color: #e6e6e6; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    header { padding: 12px 16px; background: #161a1d; border-bottom: 1px solid #23272a; }
    main { padding: 12px 16px; }
    video { width: 100%; max-width: 960px; background: #000; border-radius: 8px; border: 1px solid #23272a; }
    .controls { margin: 12px 0; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 12px; border-radius: 6px; border: 1px solid #444; background: #1f6feb; color: #fff; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .info { font-size: 0.9rem; color: #9aa0a6; }
    .error { color: #ff6b6b; }
    pre { background: #0b0d10; padding: 8px; border-radius: 6px; max-height: 240px; overflow: auto; }
  </style>
</head>
<body>
  <header>
    <h3>Raspberry Pi WebRTC Camera</h3>
  </header>
  <main>
    <div class="controls">
      <button id="btnStart">Kết nối</button>
      <span id="status" class="info">Chưa kết nối</span>
    </div>
    <video id="video" autoplay playsinline controls muted></video>
    <pre id="log" class="info"></pre>
    <p class="info">WICOM LAB: http://ip-pi:8082 — WebRTC RPI</p>
  </main>

  <script>
    const videoEl = document.getElementById('video');
    const btnStart = document.getElementById('btnStart');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    let pc = null;
    let ws = null;

    function setStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.className = 'info' + (isError ? ' error' : '');
    }
    function log(text) { logEl.textContent += text + '\n'; }

    function createPC() {
      const cfg = { iceServers: [] }; // LAN
      const pc = new RTCPeerConnection(cfg);

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws?.send(JSON.stringify({
            type: 'ice',
            ice: {
              candidate: event.candidate.candidate,
              sdpMLineIndex: event.candidate.sdpMLineIndex
            }
          }));
        }
      };

      pc.ontrack = (event) => {
        if (videoEl.srcObject !== event.streams[0]) {
          videoEl.srcObject = event.streams[0];
          setStatus('Received track video');
          log('Client: ontrack fired');
        }
      };

      pc.addTransceiver('video', { direction: 'recvonly' });
      return pc;
    }

    function connectWS() {
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const wsUrl = `${proto}://${location.host}/ws`;
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        setStatus("WebSocket opened, wait offer...");
        log("WS opened");
        // Call server: client ready to receive offer
        ws.send(JSON.stringify({ type: 'ready' }));
      };

      ws.onmessage = async (evt) => {
        log('WS message: ' + evt.data.slice(0, 80) + (evt.data.length > 80 ? '...' : ''));
        try {
          const msg = JSON.parse(evt.data);
          if (msg.type === 'hello') {
            log('Server hello: ' + (msg.message || ''));
          } else if (msg.type === 'offer') {
            setStatus("Received SDP offer, create answer...");
            const offer = { type: 'offer', sdp: msg.sdp };
            await pc.setRemoteDescription(offer);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp }));
            setStatus("Send SDP answer.Negotiating ICE...");
          } else if (msg.type === 'ice') {
            const ice = msg.ice || {};
            if (ice.candidate) {
              await pc.addIceCandidate(new RTCIceCandidate({
                candidate: ice.candidate,
                sdpMLineIndex: ice.sdpMLineIndex
              }));
            }
          } else if (msg.type === 'error') {
            setStatus("Error: " + (msg.message || 'Unknown'), true);
            log("Server error: " + (msg.message || 'Unknown'));
          } else if (msg.type === 'pong') {
            // heartbeat
          }
        } catch (e) {
          console.error(e);
          log('Client error: ' + e.toString());
        }
      };

      ws.onclose = () => {
        setStatus("WebSocket closed", true);
        log("WS closed");
      };

      ws.onerror = (err) => {
        console.error("WS error", err);
        setStatus("WebSocket error", true);
        log("WS error");
      };
    }

    btnStart.onclick = async () => {
      btnStart.disabled = true;
      setStatus("Connecting...");
      pc = createPC();
      connectWS();
    };
  </script>
</body>
</html>